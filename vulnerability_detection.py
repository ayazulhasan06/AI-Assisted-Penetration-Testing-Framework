# =========================================
# SecureProbe - Vulnerability Detection
# Optimized, Scalable, Industry-Aligned
# =========================================

import logging

# -------------------------------------------------
# Normalized Vulnerability Knowledge Base
# -------------------------------------------------
VULNERABILITY_DATABASE = {

    # =========================
    # AUTH / REMOTE ACCESS
    # =========================
    21: [
        ("FTP Anonymous Login", "HIGH",
         "Anonymous or weak FTP credentials allow unauthorized access.")
    ],
    22: [
        ("SSH Brute Force / User Enumeration", "HIGH",
         "SSH service vulnerable to password brute-force and user discovery.")
    ],
    23: [
        ("Telnet Plaintext Authentication", "CRITICAL",
         "Credentials transmitted in cleartext, enabling sniffing attacks.")
    ],
    3389: [
        ("RDP Brute Force Attack", "CRITICAL",
         "Remote Desktop susceptible to credential stuffing and brute force."),
        ("RDP BlueKeep Vulnerability", "CRITICAL",
         "Remote code execution vulnerability in RDP service.")
    ],
    5900: [
        ("VNC Weak or No Authentication", "HIGH",
         "Remote access via VNC without strong authentication.")
    ],

    # =========================
    # WEB & API (OWASP TOP 10)
    # =========================
    80: [
        ("Reflected XSS", "HIGH", "Unsanitized input reflected in responses."),
        ("Stored XSS", "CRITICAL", "Persistent malicious scripts stored server-side."),
        ("DOM-based XSS", "HIGH", "Client-side JavaScript injection."),
        ("SQL Injection – Union-Based", "CRITICAL", "Database extraction via UNION queries."),
        ("SQL Injection – Blind / Time-Based", "CRITICAL", "Inference-based database attacks."),
        ("Command Injection", "CRITICAL", "OS command execution through user input."),
        ("CSRF", "HIGH", "Unauthorized actions via forged requests."),
        ("IDOR", "HIGH", "Unauthorized object access."),
        ("Broken Authentication", "CRITICAL", "Weak session or credential handling."),
        ("File Upload RCE", "CRITICAL", "Malicious file upload leads to code execution."),
        ("Path Traversal", "HIGH", "Unauthorized file system access."),
        ("LFI / RFI", "CRITICAL", "Local or remote file inclusion."),
        ("Open Redirect", "MEDIUM", "Unvalidated redirection."),
        ("Clickjacking", "MEDIUM", "UI redress attacks.")
    ],
    443: [
        ("Weak TLS Configuration", "MEDIUM", "Deprecated ciphers or protocols enabled."),
        ("TLS Downgrade Attack", "HIGH", "Server accepts insecure TLS versions."),
        ("Improper Certificate Validation", "MEDIUM", "Invalid SSL certificate handling.")
    ],
    8080: [
        ("Exposed Web Admin Panel", "HIGH",
         "Administrative interfaces accessible without authentication.")
    ],

    # =========================
    # NETWORK / INFRASTRUCTURE
    # =========================
    53: [
        ("DNS Zone Transfer", "MEDIUM", "Unauthorized AXFR allowed.")
    ],
    139: [
        ("SMB Enumeration", "HIGH", "Information disclosure via SMB.")
    ],
    445: [
        ("SMB EternalBlue (MS17-010)", "CRITICAL", "Remote code execution via SMBv1."),
        ("SMB Ghost", "CRITICAL", "SMBv3 compression vulnerability.")
    ],
    161: [
        ("SNMP Public Community String", "HIGH", "Sensitive system data exposure.")
    ],
    389: [
        ("LDAP Anonymous Bind", "HIGH", "Unauthorized directory access.")
    ],

    # =========================
    # DATABASE / CACHE
    # =========================
    3306: [
        ("MySQL Unauthorized Access", "CRITICAL", "Database exposed without auth."),
        ("MySQL Weak Credentials", "HIGH", "Weak or default credentials.")
    ],
    5432: [
        ("PostgreSQL Trust Authentication Abuse", "HIGH",
         "Improper trust-based authentication.")
    ],
    27017: [
        ("MongoDB No Authentication", "CRITICAL",
         "Database exposed without access control.")
    ],
    6379: [
        ("Redis Unauthorized Access", "CRITICAL",
         "Redis instance accessible without password."),
        ("Redis RCE via Config Rewrite", "CRITICAL",
         "Remote command execution via Redis misconfiguration.")
    ],

    # =========================
    # CLOUD / DEVOPS / CI-CD
    # =========================
    2375: [
        ("Docker Remote API Exposure", "CRITICAL",
         "Unauthenticated Docker API allows container takeover.")
    ],
    6443: [
        ("Kubernetes API Server Exposure", "CRITICAL",
         "Cluster control plane publicly accessible.")
    ],
    9200: [
        ("Elasticsearch Unauthorized Access", "CRITICAL",
         "Sensitive index data exposed publicly.")
    ],
    8081: [
        ("CI/CD Dashboard Exposure", "HIGH",
         "Pipeline secrets and build data exposed.")
    ],
    16992: [
        ("Cloud Metadata SSRF", "CRITICAL",
         "Access to cloud instance metadata via SSRF.")
    ]
}

# -------------------------------------------------
# Detection Function
# -------------------------------------------------
def detect_vulnerabilities(open_ports):
    logging.info("Vulnerability detection started")
    findings = []

    for port in open_ports:
        if port in VULNERABILITY_DATABASE:
            for attack, severity, description in VULNERABILITY_DATABASE[port]:
                findings.append({
                    "port": port,
                    "attack": attack,
                    "severity": severity,
                    "description": description
                })

    logging.info("Vulnerability detection completed")
    return findings
